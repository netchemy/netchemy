<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Verification</title>
    <style>
        .camera-container {
            text-align: center;
            margin-top: 20px;
        }
        .video-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            display: none;
        }
        .status {
            margin-top: 20px;
        }
        .highlight {
            color: red;
        }
        .green {
            background-color: lightgreen;
            padding: 5px;
            border-radius: 50%;
        }
        #next-button, #Submit-button {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="kyc-verification-group camera-container">
        <h1>KYC Verification</h1>
        <video id="video" autoplay></video>
        <canvas id="canvas" width="640" height="480"></canvas>
        <div class="status">
            <p>Please click start to begin capturing photos.</p>
            <div id="left-indicator"></div>
            <div id="right-indicator"></div>
        </div>
        <button id="start">Start</button>
        <button id="next-button">Next</button>
    </div>

    <div class="doc-cam camera-container" style="display: none;">
        <h1>Document Capture</h1>
        <video id="document-camera" autoplay></video>
        <div class="status">
            <p id="instructions">Please take a photo of the <span class="highlight">front</span> of your document.</p>
        </div>
        <button id="shutter-button">Capture</button>
        <button id="Submit-button">Submit</button>
    </div>

    <script>
        const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startButton = document.getElementById('start');
const nextButton = document.getElementById('next-button');
const statusDiv = document.querySelector('.status');
const leftIndicator = document.getElementById('left-indicator');
const rightIndicator = document.getElementById('right-indicator');
const instructionText = document.querySelector("p");
let photoCount = 0;

const formData = new FormData();

// Access the user's webcam
navigator.mediaDevices.getUserMedia({ video: true })
    .then((stream) => {
        video.srcObject = stream;
    })
    .catch((error) => {
        console.error('Error accessing webcam:', error);
    });

// Start photo capture process
startButton.addEventListener("click", () => {
    instructionText.textContent = "Please turn your face to the left.";
    const interval = setInterval(() => {
        capturePhoto();
        photoCount++;

        if (photoCount === 1) {
            leftIndicator.classList.add("green");
            instructionText.textContent = "Please turn your face to the center.";
        } else if (photoCount === 2) {
            instructionText.textContent = "Please turn your face to the right.";
        } else if (photoCount === 3) {
            rightIndicator.classList.add("green");
            instructionText.textContent = "Photos captured successfully!";
            statusDiv.textContent = "All photos captured. Proceed to the next step.";
            clearInterval(interval);
            showNextButton();
        }
    }, 3000);
});

// Capture photo
function capturePhoto() {
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const photoData = canvas.toDataURL('image/png');
    console.log("Captured photo data:", photoData);
    formData.append(`photo${photoCount + 1}`, photoData);
}

// Show the next button
function showNextButton() {
    nextButton.style.display = 'block';
}

// Switch to document capture
nextButton.addEventListener("click", () => {
    document.querySelector(".kyc-verification-group").style.display = "none";
    document.querySelector(".doc-cam").style.display = "block";
    initializeDocumentCamera();
});

// Initialize document camera
function initializeDocumentCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then((stream) => {
            const videoElement = document.getElementById('document-camera');
            videoElement.srcObject = stream;
            videoElement.onloadedmetadata = () => videoElement.play();
        })
        .catch((error) => {
            console.error("Error accessing the camera: ", error);
        });
}

let currentStep = "front";
let capturedPhotos = {};

document.getElementById("shutter-button").addEventListener("click", () => {
    captureDocumentPhoto(currentStep);

    if (currentStep === "front") {
        document.getElementById("instructions").innerHTML =
            'Please take a photo of the <span class="highlight">back</span> of the document in proper lighting.';
        currentStep = "back";
    } else if (currentStep === "back") {
        document.getElementById("instructions").textContent =
            "Both photos captured successfully. Click Submit to proceed.";
        document.getElementById("Submit-button").style.display = "inline-block";
    }
});

function captureDocumentPhoto(step) {
    const video = document.getElementById("document-camera");
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL("image/png");
    capturedPhotos[step] = imageData;
    formData.append(`${step}-photo`, imageData);
    console.log(`Captured ${step} photo:`, imageData);
}

// Submit data
document.getElementById("Submit-button").addEventListener("click", () => {
    if (!capturedPhotos.front || !capturedPhotos.back || !formData.get("photo1") || !formData.get("photo2") || !formData.get("photo3")) {
        alert("Please ensure all photos are captured!");
        return;
    }

    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        alert("Access token is missing!");
        return;
    }

    // Get the CSRF token from the cookie
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        alert("CSRF token missing!");
        return;
    }

    fetch('/kyc/SubmitKYC/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`,
            'X-CSRFToken': csrfToken // Add CSRF token in the header
        },
        body: JSON.stringify({
            photo1: formData.get("photo1"),
            photo2: formData.get("photo2"),
            photo3: formData.get("photo3"),
            front: capturedPhotos.front,
            back: capturedPhotos.back
        })
    })
        .then(response => response.ok ? response.json() : Promise.reject(response.status))
        .then(data => {
            alert("Submission successful!");
            console.log('Server response:', data);
            window.location.href = '/';
        })
        .catch(error => {
            console.error('Error uploading photos:', error);
            alert('Error uploading photos. Please try again.');
        });
});

// Helper function to get CSRF token from cookies
function getCookie(name) {
    const cookieValue = document.cookie.split(';').find(cookie => cookie.trim().startsWith(name + "="));
    return cookieValue ? decodeURIComponent(cookieValue.split('=')[1]) : null;
}



    </script>


</body>
</html>
